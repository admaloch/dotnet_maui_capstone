<ContentPage
    x:Class="c971_project.Views.SearchPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:helpers="clr-namespace:c971_project.Helpers"
    xmlns:models="clr-namespace:c971_project.Models"
    Title="Search">


    <ContentPage.Resources>
        <helpers:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
        <helpers:InverseBoolConverter x:Key="InverseBoolConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!--  Search Header  -->
            <Label
                FontAttributes="Bold"
                FontSize="24"
                HorizontalOptions="Center"
                Text="Global Search" />

            <!--  Search Box  -->
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                <Entry
                    Grid.Column="0"
                    Placeholder="Search courses, terms, assessments..."
                    ReturnCommand="{Binding SearchCommand}"
                    Text="{Binding SearchQuery}" />
                <Button
                    Grid.Column="1"
                    BackgroundColor="{StaticResource Primary}"
                    Command="{Binding SearchCommand}"
                    Text="Search"
                    TextColor="White" />
            </Grid>

            <!--  Clear Search  -->
            <Button
                BackgroundColor="{StaticResource Gray500}"
                Command="{Binding ClearSearchCommand}"
                HorizontalOptions="Center"
                IsVisible="{Binding HasSearched}"
                Text="Clear Search" />

            <!--  Loading Indicator  -->
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsSearching}"
                IsVisible="{Binding IsSearching}" />

            <!--  No Results Message  -->
            <Label
                FontAttributes="Italic"
                HorizontalOptions="Center"
                IsVisible="{Binding HasSearched, Converter={StaticResource InverseBoolConverter}}"
                Text="No results found. Try different search terms."
                TextColor="{StaticResource Gray500}" />

            <!--  Search Results  -->
            <VerticalStackLayout IsVisible="{Binding SearchResults.HasResults}" Spacing="15">

                <!--  Terms Results  -->
                <VerticalStackLayout IsVisible="{Binding SearchResults.Terms.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Terms" />
                    <CollectionView ItemsSource="{Binding SearchResults.Terms}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Term">
                                <Grid
                                    Margin="0,2"
                                    Padding="15"
                                    BackgroundColor="{StaticResource Gray100}"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label FontAttributes="Bold" Text="{Binding Name}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding StartDate, StringFormat='{0:MMM dd, yyyy} - {1:MMM dd, yyyy}'}"
                                            TextColor="{StaticResource Gray600}" />
                                    </VerticalStackLayout>
                                    <Label
                                        Grid.Column="1"
                                        FontSize="16"
                                        Text="→"
                                        VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SearchViewModel}}, Path=NavigateToResultCommand}" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!--  Courses Results  -->
                <VerticalStackLayout IsVisible="{Binding SearchResults.Courses.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Courses" />
                    <CollectionView ItemsSource="{Binding SearchResults.Courses}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Course">
                                <Grid
                                    Margin="0,2"
                                    Padding="15"
                                    BackgroundColor="{StaticResource Gray100}"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label FontAttributes="Bold" Text="{Binding Name}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding CourseNum}"
                                            TextColor="{StaticResource Gray600}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding Status}"
                                            TextColor="{StaticResource Gray600}" />
                                    </VerticalStackLayout>
                                    <Label
                                        Grid.Column="1"
                                        FontSize="16"
                                        Text="→"
                                        VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SearchViewModel}}, Path=NavigateToResultCommand}" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!--  Assessments Results  -->
                <VerticalStackLayout IsVisible="{Binding SearchResults.Assessments.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Assessments" />
                    <CollectionView ItemsSource="{Binding SearchResults.Assessments}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Assessment">
                                <Grid
                                    Margin="0,2"
                                    Padding="15"
                                    BackgroundColor="{StaticResource Gray100}"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label FontAttributes="Bold" Text="{Binding Name}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding Type}"
                                            TextColor="{StaticResource Gray600}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding StartDate, StringFormat='Due: {0:MMM dd, yyyy}'}"
                                            TextColor="{StaticResource Gray600}" />
                                    </VerticalStackLayout>
                                    <Label
                                        Grid.Column="1"
                                        FontSize="16"
                                        Text="→"
                                        VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SearchViewModel}}, Path=NavigateToResultCommand}" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!--  Notes Results  -->
                <VerticalStackLayout IsVisible="{Binding SearchResults.Notes.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Notes" />
                    <CollectionView ItemsSource="{Binding SearchResults.Notes}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Note">
                                <Grid
                                    Margin="0,2"
                                    Padding="15"
                                    BackgroundColor="{StaticResource Gray100}"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label FontAttributes="Bold" Text="{Binding Title}" />
                                        <Label
                                            FontSize="12"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="2"
                                            Text="{Binding Body}"
                                            TextColor="{StaticResource Gray600}" />
                                    </VerticalStackLayout>
                                    <Label
                                        Grid.Column="1"
                                        FontSize="16"
                                        Text="→"
                                        VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SearchViewModel}}, Path=NavigateToResultCommand}" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!--  Instructors Results  -->
                <VerticalStackLayout IsVisible="{Binding SearchResults.Instructors.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Instructors" />
                    <CollectionView ItemsSource="{Binding SearchResults.Instructors}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Instructor">
                                <Grid
                                    Margin="0,2"
                                    Padding="15"
                                    BackgroundColor="{StaticResource Gray100}"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label FontAttributes="Bold" Text="{Binding Name}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding Email}"
                                            TextColor="{StaticResource Gray600}" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding Phone}"
                                            TextColor="{StaticResource Gray600}" />
                                    </VerticalStackLayout>
                                    <Label
                                        Grid.Column="1"
                                        FontSize="16"
                                        Text="→"
                                        VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SearchViewModel}}, Path=NavigateToResultCommand}" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>